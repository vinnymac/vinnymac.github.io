{"componentChunkName":"component---src-templates-post-template-js","path":"/posts/hardware-transcoding/","webpackCompilationHash":"c25ac13ed87f966527db","result":{"data":{"markdownRemark":{"id":"34909d7e-925f-5191-9cca-186a4225f975","html":"<p>This holiday season I had some down time. My wife and I were watching a home video on Plex when I noticed some artifacting on our Samsung TV. While this can be easily solved by transcoding all of my media to the lowest common denominator client device, it would require a lot of processing power and time to go through the entire content library. Additionally, without knowing which devices my family members all use, I would have no way of creating a reliable experience for them. For my own needs, changing to a client device that supports the media I was playing is the most straightforward solution. For those who are sharing their Plex with family and friends, you will want to look closer at your hardware.</p>\n<h3 id=\"research\"><a href=\"#research\" aria-label=\"research permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Research</h3>\n<p>I began researching why this was happening to my headless Ubuntu server. Starting with the hardware, I knew that out of the box, Plex will use your integrated graphics chip on the processor to handle any decoding or encoding, and will ultimately fallback to the CPU. The server in my basement today is currently running on fairly old hardware, the CPU is actually an <strong>i7-4790k</strong>. A quick search reveals an Intel specification <a href=\"https://ark.intel.com/content/www/us/en/ark/products/80807/intel-core-i7-4790k-processor-8m-cache-up-to-4-40-ghz.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">here</a>. This page explains that the CPU has the following Processor Graphics.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Processor Graphics ‡ Intel® HD Graphics 4600\nGraphics Base Frequency 350 MHz\nGraphics Max Dynamic Frequency 1.25 GHz\nGraphics Video Max Memory 2 GB\nGraphics Output eDP/DP/HDMI/DVI/VGA\nExecution Units 20\nMax Resolution (HDMI)‡ 3840x2160@24Hz\nMax Resolution (DP)‡ 3840x2160@60Hz\nMax Resolution (eDP - Integrated Flat Panel)‡ 3840x2160@60Hz\nMax Resolution (VGA)‡ 1920x1200@60Hz\nDirectX* Support 11.2/12\nOpenGL* Support 4.3\nIntel® Quick Sync Video Yes\nIntel® InTru™ 3D Technology Yes\nIntel® Flexible Display Interface (Intel® FDI) Yes\nIntel® Clear Video HD Technology Yes\n# of Displays Supported ‡ 3\nDevice ID 0x412</code></pre></div>\n<p>While the Intel® HD Graphics 4600 is very capable for it’s time, it isn’t as powerful as more modern integrated graphics. Using Intel’s integrated graphics worked well for years, and I highly recommend using it if your server has a newer chipset, such as a <a href=\"https://ark.intel.com/content/www/us/en/ark/products/graphics/126790/intel-uhd-graphics-630.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">UHD 630</a>. However, in my case, upgrading my entire 1150 LGA system was not within budget. So I looked at alternative solutions, such as a dedicated GPU.</p>\n<h3 id=\"purchase\"><a href=\"#purchase\" aria-label=\"purchase permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Purchase</h3>\n<p>Knowing that I wanted a dedicated GPU over an integrated one, I made a list of requirements comparing various GPUs on sale. Mainly something that was not too expensive (under $150), energy-efficient, and somewhat future-proof. Fortunately a <a href=\"https://www.elpamsoft.com/?p=Plex-Hardware-Transcoding\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Plex Hardware Transcoding chart</a> was built that makes considering which GPU to get a breeze. I made note of the <code class=\"language-text\">Quadro P3000 (6GB)</code>, <code class=\"language-text\">GeForce GTX 1060 (6GB)</code>, <code class=\"language-text\">Geforce GTX 1660 (6GB)</code>, and <code class=\"language-text\">GeForce GTX 1660 Ti (6GB)</code> options.</p>\n<p><a href=\"/plex/transcode_chart.png\"><img src=\"/plex/transcode_chart.png\" alt=\"Screenshot of 1080p to 720p GPU Transcode Comparison\"></a></p>\n<p>Looking at the chart above, these GPUs can support upto twenty simultaneous transcode streams. While all the GeForce GTX GPUs are limited to three simultaneous transcodes, a <a href=\"https://github.com/keylase/nvidia-patch\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">driver patch</a> can be applied on Windows and Linux to remove this unnecessary limitation. Once the limitation is removed, the devices are capable of a theoretically unlimited number of transcode sessions. The next likely bottleneck for the GPU to run into is VRAM, and the options I chose above, all have 6GBs memory (while the Intel® HD Graphics 4600 had a measly 2GB). Of course, if you just go with a Quadro GPU instead, you don’t have to deal with this headache. However, Quadro GPUs tend to be more expensive, which makes them a less desirable option in this scenario, but they are certainly the easier choice.</p>\n<p>And so my hunt for a GPU began. I shopped around, and found some decent deals, but nothing was as good as what I saw on eBay, OfferUp, Mercari, and Craigslist. After being outbid on a couple <code class=\"language-text\">GeForce GTX 1660 (6GB)</code>, I ended up snagging an MSI Aero <code class=\"language-text\">GeForce GTX 1060 (6 GB)</code> in an ITX Form Factor on Mercari for $100. The GPU arrived in the mail in 5 days, and was in really great condition.</p>\n<p><a href=\"/plex/msi_aero_1060_6gb_itx.jpg\"><img src=\"/plex/msi_aero_1060_6gb_itx.jpg\" alt=\"Photo of the GeForce GTX 1060 (6GB)\"></a></p>\n<h3 id=\"installation\"><a href=\"#installation\" aria-label=\"installation permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Installation</h3>\n<p>Installing the GeForce GTX 1660 inside of my server was easy. I shut down the computer safely, and unplugged all of my peripheral devices. Removed the metallic door on the server, and took a peek inside. Despite the machines age, it is in pretty good condition, at least when ignoring the hideous cable management.</p>\n<p><a href=\"/plex/ugly_server_internals.jpg\"><img src=\"/plex/ugly_server_internals.jpg\" alt=\"Ugly Photo of the inside of the Server\"></a></p>\n<p>After grabbing a 6-Pin PCI-E cable for the power supply and plugging in the graphics card, I was ready to turn the machine on. Expecting everything to go off without a hitch, I was sorely disappointed when video was no longer being displayed. Neither via the new GPU or the old. It seemed pretty clear to me that the computer was not POSTing. I knew that my 750 Watt PSU was capable of supplying enough power to support this 120 Watt (Max) Graphics Card, so I knew to look elsewhere.</p>\n<p>Removing the Graphics Card alleviated the issue, but of course that is not the goal. I reexamined the setup and found the culprit to be the motherboards Voltage Protection. After changing the outlet that my server is plugged into in the APC Battery Backup, everything started working as expected. I suspected this was the issue, due to the fact that when plugged directly into a wall outlet, the computer booted. The Battery Backup only has around a 8% load, so it is certainly not drawing too much from it. If I had to guess, I’d say the older ASUS chipset on my motherboard likely has some protections in place that are misfiring. If anyone is more familiar with battery backups, I’d be interested to hear your thoughts on why this happens. I am just glad it was such an easy fix.</p>\n<h3 id=\"nvidia-drivers\"><a href=\"#nvidia-drivers\" aria-label=\"nvidia drivers permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Nvidia Drivers</h3>\n<p>Before running the <code class=\"language-text\">nvidia-patch</code> to remove the limitation on the GeForce GTX 1060 I needed to install the approriate nvidia drivers. While you can follow the instructions as described in the <a href=\"https://github.com/keylase/nvidia-patch\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Github README</a> of <code class=\"language-text\">nvidia-patch</code>, you can also do this using your OS’ package manager.</p>\n<p>I started by running the following command, which recommended a driver for my graphics card. Below you can see the recommended driver is <code class=\"language-text\">nvidia-driver-455</code>. This happened to be the same one <code class=\"language-text\">nvidia-patch</code> recommended, so if you have a different list, keep an eye out that the driver is compatible with the patch you are applying.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">sudo</span> ubuntu-drivers devices\n<span class=\"token operator\">==</span> /sys/devices/pci0000:00/0000:00:01.0/0000:01:00.0 <span class=\"token operator\">==</span>\nmodalias <span class=\"token keyword\">:</span> pci:v000010DEd00001C03sv00001462sd00003283bc03sc00i00\nvendor   <span class=\"token keyword\">:</span> NVIDIA Corporation\nmodel    <span class=\"token keyword\">:</span> GP106 <span class=\"token punctuation\">[</span>GeForce GTX 1060 6GB<span class=\"token punctuation\">]</span>\ndriver   <span class=\"token keyword\">:</span> nvidia-driver-390 - distro non-free\ndriver   <span class=\"token keyword\">:</span> nvidia-driver-450 - distro non-free\ndriver   <span class=\"token keyword\">:</span> nvidia-driver-450-server - distro non-free\ndriver   <span class=\"token keyword\">:</span> nvidia-driver-455 - distro non-free recommended\ndriver   <span class=\"token keyword\">:</span> nvidia-driver-418-server - distro non-free\ndriver   <span class=\"token keyword\">:</span> nvidia-driver-440-server - distro non-free\ndriver   <span class=\"token keyword\">:</span> xserver-xorg-video-nouveau - distro <span class=\"token function\">free</span> <span class=\"token function\">builtin</span></code></pre></div>\n<p>Next I installed the recommended driver for my graphics card and rebooted.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> nvidia-driver-455\n$ <span class=\"token function\">sudo</span> <span class=\"token function\">reboot</span></code></pre></div>\n<p>I checked that the driver was installed successfully after rebooting by running <code class=\"language-text\">nvidia-smi</code>. Normally this would work as expected. Unfortunately my server BIOS had been configured to enable Secure Boot. On many modern motherboards you can just run the following command to import the secure key so that the OS will allow the driver to run.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">sudo</span> mokutil --import /var/lib/shim-signed/mok/MOK.der</code></pre></div>\n<p>After rebooting, the driver was not available, and <code class=\"language-text\">mokutil</code> failed with every command, including when using the <code class=\"language-text\">--import</code> argument. After a bit of digging, I learned that on some motherboards, you can enroll keys in the BIOS SecureBoot setup. After installing the nvidia driver via apt, you’ll find the necessary key blob data in <code class=\"language-text\">/var/lib/shim-signed/mok</code> named <code class=\"language-text\">MOK.der</code>. This file is unique to my computer, and future driver installs will be signed with the same key. </p>\n<p>I copied the <code class=\"language-text\">MOK.der</code> to a USB, and then rebooted into the BIOS. For my BIOS, I enabled <code class=\"language-text\">Advanced Mode</code> and then navigated to <code class=\"language-text\">Boot/SecureBoot/KeyManagement</code>. Here I found a lot of different options, but the one I needed was called <code class=\"language-text\">Append to Default DB</code>. A prompt appeared when selecting this option, choosing <code class=\"language-text\">No</code> allowed me to select a file from the USB. After selecting the <code class=\"language-text\">MOK.der</code> from the USB, a prompt popped up asking what type of data the file contains. I chose <code class=\"language-text\">Blob Data</code> and then saved (pressed F10) and rebooted.</p>\n<p>Once the computer restarted, I ran <code class=\"language-text\">nvidia-smi</code>. Finally the driver was installed and running.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ nvidia-smi\nSat Dec 19 17:38:11 2020\n+-----------------------------------------------------------------------------+\n<span class=\"token operator\">|</span> NVIDIA-SMI 455.38       Driver Version: 455.38       CUDA Version: 11.1     <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>-------------------------------+----------------------+----------------------+\n<span class=\"token operator\">|</span> GPU  Name        Persistence-M<span class=\"token operator\">|</span> Bus-Id        Disp.A <span class=\"token operator\">|</span> Volatile Uncorr. ECC <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> Fan  Temp  Perf  Pwr:Usage/Cap<span class=\"token operator\">|</span>         Memory-Usage <span class=\"token operator\">|</span> GPU-Util  Compute M. <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>                               <span class=\"token operator\">|</span>                      <span class=\"token operator\">|</span>               MIG M. <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">=</span>+<span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span>+<span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>   0  GeForce GTX 106<span class=\"token punctuation\">..</span>.  Off  <span class=\"token operator\">|</span> 00000000:01:00.0  On <span class=\"token operator\">|</span>                  N/A <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  0%   33C    P8     4W / 120W <span class=\"token operator\">|</span>      4MiB /  6075MiB <span class=\"token operator\">|</span>      0%      Default <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>                               <span class=\"token operator\">|</span>                      <span class=\"token operator\">|</span>                  N/A <span class=\"token operator\">|</span>\n+-------------------------------+----------------------+----------------------+\n\n+-----------------------------------------------------------------------------+\n<span class=\"token operator\">|</span> Processes:                                                                  <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  GPU   GI   CI        PID   Type   Process name                  GPU Memory <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>        ID   ID                                                   Usage      <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">=</span><span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  No running processes found                                                 <span class=\"token operator\">|</span>\n+-----------------------------------------------------------------------------+</code></pre></div>\n<h3 id=\"plex-and-docker\"><a href=\"#plex-and-docker\" aria-label=\"plex and docker permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Plex and Docker</h3>\n<p>Now that the driver was functioning properly, and the graphics device appeared under <code class=\"language-text\">/dev/dri</code> I could configure Plex to use it. Currently, I run Plex within a container using Docker. To use a nvidia GPU with docker I had to follow the Nvidia docker documentation <a href=\"https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/install-guide.html#docker\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">here</a>. So I ran the following command, as described in the documentation.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> update <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> -y nvidia-docker2</code></pre></div>\n<p>Since I use <code class=\"language-text\">docker-compose</code>, I assumed I would need to update the <code class=\"language-text\">docker-compose.yml</code> file where the plex service is defined. Although the devices don’t need to change because I previously configured Intel Quick Sync transcoding, it is important that we set the appropriate environment variables. For us to get full hardware transcoding functioning correctly, we must set <code class=\"language-text\">NVIDIA_VISIBLE_DEVICES=all</code> and <code class=\"language-text\">NVIDIA_DRIVER_CAPABILITIES=compute,video,utility</code>. This will allow all of our Nvidia graphics devices and the associated libraries to be accessible from within the docker container. See my updated <code class=\"language-text\">docker-compose.yml</code> below which includes both environment variables.</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'3.7'</span>\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">plex</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> plexinc/pms<span class=\"token punctuation\">-</span>docker<span class=\"token punctuation\">:</span>latest\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> unless<span class=\"token punctuation\">-</span>stopped\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> PLEX_UID=0\n      <span class=\"token punctuation\">-</span> PLEX_GID=0\n      <span class=\"token punctuation\">-</span> TZ=$<span class=\"token punctuation\">{</span>TZ<span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">-</span> CHANGE_CONFIG_DIR_OWNERSHIP=true\n      <span class=\"token punctuation\">-</span> NVIDIA_VISIBLE_DEVICES=all\n      <span class=\"token punctuation\">-</span> NVIDIA_DRIVER_CAPABILITIES=compute<span class=\"token punctuation\">,</span>video<span class=\"token punctuation\">,</span>utility\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> 32400<span class=\"token punctuation\">:</span>32400/tcp\n      <span class=\"token punctuation\">-</span> 3005<span class=\"token punctuation\">:</span>3005/tcp\n      <span class=\"token punctuation\">-</span> 8324<span class=\"token punctuation\">:</span>8324/tcp\n      <span class=\"token punctuation\">-</span> 32469<span class=\"token punctuation\">:</span>32469/tcp\n      <span class=\"token punctuation\">-</span> 1900<span class=\"token punctuation\">:</span>1900/udp\n      <span class=\"token punctuation\">-</span> 32410<span class=\"token punctuation\">:</span>32410/udp\n      <span class=\"token punctuation\">-</span> 32412<span class=\"token punctuation\">:</span>32412/udp\n      <span class=\"token punctuation\">-</span> 32413<span class=\"token punctuation\">:</span>32413/udp\n      <span class=\"token punctuation\">-</span> 32414<span class=\"token punctuation\">:</span>32414/udp\n    <span class=\"token key atrule\">devices</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> /dev/dri<span class=\"token punctuation\">:</span>/dev/dri\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> $<span class=\"token punctuation\">{</span>CONFIG_ROOT<span class=\"token punctuation\">}</span>/config/plex/db<span class=\"token punctuation\">:</span>/config\n      <span class=\"token punctuation\">-</span> $<span class=\"token punctuation\">{</span>CONFIG_ROOT<span class=\"token punctuation\">}</span>/config/plex/transcode<span class=\"token punctuation\">:</span>/transcode</code></pre></div>\n<p>I use version 3.7 of <code class=\"language-text\">docker-compose</code>, so unfortunately configuring the nvidia runtime is a bit more indirect. If you use the version 2 configuration of <code class=\"language-text\">docker-compose</code> you can just add <code class=\"language-text\">runtime: nvidia</code> to the <code class=\"language-text\">docker-compose.yml</code> instead. But for 3.7 I needed to update the <code class=\"language-text\">/etc/docker/daemon.json</code> with the following.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"default-runtime\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"nvidia\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"runtimes\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"nvidia\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"path\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"nvidia-container-runtime\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"runtimeArgs\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now that I have docker configured to use the nvidia runtime, I need to restart the docker service. This can be easily done on Ubuntu server by executing the following command.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">sudo</span> <span class=\"token function\">service</span> docker restart</code></pre></div>\n<p>Then I restarted the services that manage my container orchestration.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">sudo</span> <span class=\"token function\">service</span> theater restart</code></pre></div>\n<p>I verified that the correct libraries were made available to the container using the following command.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ docker <span class=\"token function\">exec</span> -it plex ldconfig -p <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> -i nvidia\n  libnvidia-ptxjitcompiler.so.1 <span class=\"token punctuation\">(</span>libc6,x86-64<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> /usr/lib/x86_64-linux-gnu/libnvidia-ptxjitcompiler.so.1\n  libnvidia-opticalflow.so.1 <span class=\"token punctuation\">(</span>libc6,x86-64<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> /usr/lib/x86_64-linux-gnu/libnvidia-opticalflow.so.1\n  libnvidia-opencl.so.1 <span class=\"token punctuation\">(</span>libc6,x86-64<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> /usr/lib/x86_64-linux-gnu/libnvidia-opencl.so.1\n  libnvidia-ml.so.1 <span class=\"token punctuation\">(</span>libc6,x86-64<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> /usr/lib/x86_64-linux-gnu/libnvidia-ml.so.1\n  libnvidia-encode.so.1 <span class=\"token punctuation\">(</span>libc6,x86-64<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> /usr/lib/x86_64-linux-gnu/libnvidia-encode.so.1\n  libnvidia-compiler.so.455.38 <span class=\"token punctuation\">(</span>libc6,x86-64<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> /usr/lib/x86_64-linux-gnu/libnvidia-compiler.so.455.38\n  libnvidia-cfg.so.1 <span class=\"token punctuation\">(</span>libc6,x86-64<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> /usr/lib/x86_64-linux-gnu/libnvidia-cfg.so.1\n  libnvidia-allocator.so.1 <span class=\"token punctuation\">(</span>libc6,x86-64<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> /usr/lib/x86_64-linux-gnu/libnvidia-allocator.so.1</code></pre></div>\n<p>Then verified <code class=\"language-text\">nvidia-smi</code> functions as expected.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ docker <span class=\"token function\">exec</span> -it plex nvidia-smi</code></pre></div>\n<p>I saw the same output as before when running <code class=\"language-text\">nvidia-smi</code> so I knew the container had access to the graphics device. Now we just need to make sure plex is able to transcode media. I played the video that was originally producing artifacts on my TV. On another device, I opened a browser, navigated to my plex server, and then went from Settings to Manage / Console. Here I could filter the Console logs however I wanted. </p>\n<p>For those adverse to using the Plex dashboard, you can easily do this on the server like so.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">tail</span> -f plex/db/Library/Application\\ Support/Plex\\ Media\\ Server/Logs/Plex\\ Media\\ Server.log <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> <span class=\"token string\">\"TPU:\"</span></code></pre></div>\n<p>If I filter by <strong>TPU:</strong> or <strong>MDE:</strong> I can see what device is being used for transcoding and why transcoding is happening. <a href=\"https://forums.plex.tv/t/transcoding-with-gpu/444318/19\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Below is a helpful list</a> of terms I found that can be used for debugging.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">MDE:\nTPU:\nffmpeg\ncodec\ndecoder\nencoder\nhardware</code></pre></div>\n<p>The output shows the following when filtered by <strong>TPU:</strong>.</p>\n<div class=\"gatsby-highlight\" data-language=\"log\"><pre class=\"language-log\"><code class=\"language-log\">Dec 19, 2020 13:36:34.912 [0x7fea797fa700] DEBUG - [Transcode] TPU: hardware transcoding: using hardware decode accelerator nvdec\nDec 19, 2020 13:36:34.912 [0x7fea797fa700] DEBUG - [Transcode] TPU: hardware transcoding: zero-copy support present\nDec 19, 2020 13:36:34.912 [0x7fea797fa700] DEBUG - [Transcode] TPU: hardware transcoding: using zero-copy transcoding\nDec 19, 2020 13:36:34.912 [0x7fea797fa700] DEBUG - [Transcode] TPU: hardware transcoding: final decoder: nvdec, final encoder: nvenc</code></pre></div>\n<p>Analyzing these logs, I saw that both <strong>nvdec</strong> (Nvidia Decoding) and <strong>nvenc</strong> (Nvidia Encoding) were being used when hardware transcoding. While Plex was busy, I also ran <code class=\"language-text\">watch -n 0.5 nvidia-smi</code> in a separate tmux session. This made it easy to monitor the GPU temperature, usage, and power draw. Fortunately, while idle the GPU stays around <strong>35° Celsius</strong> and draws <strong>~4 Watts</strong>. During load on two streams I saw the temperatures rise 13° to <strong>48° Celsius</strong> and wattage increase to <strong>~35 Watts</strong>. While the GPU has its own limitations, Plex will fallback to the CPU if it can’t use the GPU for some reason, such as an unsupported format or the GPU being too busy. However, it is not capable of load balancing between multiple GPUs such as multiple GeForce GTX 1060s or the Intel® HD Graphics 4600 coprocessor. </p>\n<h3 id=\"was-it-all-worth-it\"><a href=\"#was-it-all-worth-it\" aria-label=\"was it all worth it permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Was it all worth it?</h3>\n<p>My wife and I can now watch videos without weird artifacts appearing on our TV, and my family and friends can do so without having to worry so much about which device they are using. If you are interested in reading more about hardware accelerated streaming with Plex, they have a great article on the subject <a href=\"https://support.plex.tv/articles/115002178853-using-hardware-accelerated-streaming/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">here</a>. While this was an afforable and fun upgrade for my server, your system will likely have different needs and requirements. If you are building from scratch, the easiest path will certainly be to get an Intel processor that has powerful integrated graphics. The newer (2021) <a href=\"https://en.wikipedia.org/wiki/Rocket_Lake#GPU\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Rocket Lake</a> processors for example will support hardware decoding for HEVC 12-bit, 4:2:2/4:4:4; VP9 12-bit 4:4:4 and AV1 8K 10-bit 4:2:0. When considering building a Plex Server of your own, I recommend reusing what you can. Many users of Plex have it running on nothing but a Raspberry PI, but for those users, you can be sure they are mostly utilizing direct play over transcoding.</p>","fields":{"slug":"/posts/hardware-transcoding/","tagSlugs":["/tag/plex/","/tag/nvidia/","/tag/transcoding/","/tag/linux/","/tag/ubuntu/"]},"frontmatter":{"date":"2020-12-19T05:38:00.000Z","description":"Plex Transcoding with Nvidia GPUs","tags":["plex","nvidia","transcoding","linux","ubuntu"],"title":"Hardware Transcoding"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/posts/hardware-transcoding/"}}}