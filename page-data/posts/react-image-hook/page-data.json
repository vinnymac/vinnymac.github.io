{"componentChunkName":"component---src-templates-post-template-js","path":"/posts/react-image-hook/","webpackCompilationHash":"c9a52c2757644449e755","result":{"data":{"markdownRemark":{"id":"b1762b00-69f8-5650-bf95-1bc16b7bba59","html":"<p>A frequent problem I run into in web development is image loading. The web has built-ins for this, such as <code class=\"language-text\">&lt;img /&gt;</code> and <code class=\"language-text\">&lt;picture /&gt;</code>. They are not that powerful or flexible however. What if you need fallbacks, or want to do something fancy with low quality image placeholders then you may need something better. Image loading in JS also needs to have a flexible API that happens to work across any browser, lets say IE10 and up, as well as the last 2 versions of Firefox, Chrome, Edge, et cetera. This comes with a lot of trade offs, and you can feel like you are walking on egg shells at times. It would be nice if we could use the modern <code class=\"language-text\">Promise</code> API instead of the old <code class=\"language-text\">onload</code> and <code class=\"language-text\">onerror</code> callbacks we are used to. By the end of this short read, you should feel like you can load images for any use case, and even better with React Hooks!</p>\n<p>So lets start by creating a module <code class=\"language-text\">loadImage.js</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">url</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Next we are going to want to create an image that can tell the browser we want to download an image. This is done by setting the <code class=\"language-text\">src</code> property of the image to a particular url. In some cases this might be across origins, so lets add an option for that as well.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">url<span class=\"token punctuation\">,</span> crossOrigin</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> image <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Image</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>crossOrigin<span class=\"token punctuation\">)</span> image<span class=\"token punctuation\">.</span>crossOrigin <span class=\"token operator\">=</span> crossOrigin\n\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    image<span class=\"token punctuation\">.</span>src <span class=\"token operator\">=</span> url\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>We haven’t implemented our promise API properly yet however. We need to tell the promise whether or not the image downloaded successfully or failed. This can be done with <code class=\"language-text\">addEventListener</code> or the older <code class=\"language-text\">on</code> event callbacks, such as <code class=\"language-text\">onload</code>, <code class=\"language-text\">onerror</code>, or <code class=\"language-text\">onabort</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">url<span class=\"token punctuation\">,</span> crossOrigin</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> image <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Image</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>crossOrigin<span class=\"token punctuation\">)</span> image<span class=\"token punctuation\">.</span>crossOrigin <span class=\"token operator\">=</span> crossOrigin\n\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">loaded</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">event</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">errored</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    image<span class=\"token punctuation\">.</span>onload <span class=\"token operator\">=</span> loaded\n    image<span class=\"token punctuation\">.</span>onerror <span class=\"token operator\">=</span> errored\n    image<span class=\"token punctuation\">.</span>onabort <span class=\"token operator\">=</span> errored\n\n    image<span class=\"token punctuation\">.</span>src <span class=\"token operator\">=</span> url\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Nice now we can finally give it a try and see if that worked.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> loadImage <span class=\"token keyword\">from</span> <span class=\"token string\">'./loadImage.js'</span>\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getImage</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">url</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> img <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">loadImage</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n        <span class=\"token comment\">// Use `img` however we want, cache it or measure it</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>img<span class=\"token punctuation\">.</span>src<span class=\"token punctuation\">,</span> img<span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">,</span> img<span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// report error, load fallback, retry, et cetera</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">getImage</span><span class=\"token punctuation\">(</span><span class=\"token string\">'https://vincenttaverna.com/media/image-1.jpg'</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Great it works, but with one caveat. Our callbacks are never being cleaned up. We never called <code class=\"language-text\">removeEventListener</code> or more specifically in this case we forgot to unbind our events. Nothing to fret over, we can easily do so by adding an <code class=\"language-text\">unbindEvents</code> method.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">url<span class=\"token punctuation\">,</span> crossOrigin</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> image <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Image</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>crossOrigin<span class=\"token punctuation\">)</span> image<span class=\"token punctuation\">.</span>crossOrigin <span class=\"token operator\">=</span> crossOrigin\n\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">loaded</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">event</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">unbindEvents</span><span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">)</span>\n      <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">errored</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">unbindEvents</span><span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">)</span>\n      <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    image<span class=\"token punctuation\">.</span>onload <span class=\"token operator\">=</span> loaded\n    image<span class=\"token punctuation\">.</span>onerror <span class=\"token operator\">=</span> errored\n    image<span class=\"token punctuation\">.</span>onabort <span class=\"token operator\">=</span> errored\n\n    image<span class=\"token punctuation\">.</span>src <span class=\"token operator\">=</span> url\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">unbindEvents</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">image</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  image<span class=\"token punctuation\">.</span>onload <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n  image<span class=\"token punctuation\">.</span>onerror <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n  image<span class=\"token punctuation\">.</span>onabort <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>To get older browser support you will need to polyfill the <code class=\"language-text\">Promise</code> API. You may also need to use <code class=\"language-text\">e.target || e.srcElement</code> instead to get older IE to cooperate, but otherwise this should work across many different browsers and OS’. Below you can find the complete example with these macro modifications.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">url<span class=\"token punctuation\">,</span> crossOrigin</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> image <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Image</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// Support cross origin requests</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>crossOrigin<span class=\"token punctuation\">)</span> image<span class=\"token punctuation\">.</span>crossOrigin <span class=\"token operator\">=</span> crossOrigin\n\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Load Handler</span>\n    <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">loaded</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">event</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// Cleanup our image element, we no longer need it</span>\n      <span class=\"token function\">unbindEvents</span><span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">)</span>\n      <span class=\"token comment\">// Fulfill our promise with the event image element, even in older browsers</span>\n      <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>target <span class=\"token operator\">||</span> event<span class=\"token punctuation\">.</span>srcElement<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// Error Handler</span>\n    <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">errored</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// Cleanup our image element, we no longer need it</span>\n      <span class=\"token function\">unbindEvents</span><span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">)</span>\n      <span class=\"token comment\">// Forward our error to the user</span>\n      <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// Set our handlers</span>\n    image<span class=\"token punctuation\">.</span>onload <span class=\"token operator\">=</span> loaded\n    image<span class=\"token punctuation\">.</span>onerror <span class=\"token operator\">=</span> errored\n    image<span class=\"token punctuation\">.</span>onabort <span class=\"token operator\">=</span> errored\n\n    <span class=\"token comment\">// Tell the browser we are ready to begin downloading</span>\n    image<span class=\"token punctuation\">.</span>src <span class=\"token operator\">=</span> url\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">unbindEvents</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">image</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Reset callbacks</span>\n  image<span class=\"token punctuation\">.</span>onload <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n  image<span class=\"token punctuation\">.</span>onerror <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n  image<span class=\"token punctuation\">.</span>onabort <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Some browsers need you to remove the src</span>\n    <span class=\"token comment\">// in order to garbage collect the image object</span>\n    <span class=\"token keyword\">delete</span> image<span class=\"token punctuation\">.</span>src\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Safari's strict mode throws, ignore</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Okay, well now we have a useful helper for loading images, but what else can we do with this? I mean I don’t even know how to use this with my cool new React SPA 😡. What if we were to instead wrap this in a React Hook so we could use it across an existing application 😁? Let’s create a hook called <code class=\"language-text\">useImage</code> and see if we can use this new helper effectively.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> loadImage <span class=\"token keyword\">from</span> <span class=\"token string\">'./loadImage.js'</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">function</span> <span class=\"token function\">useImage</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">src</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>We are going to need to keep track of the state (<code class=\"language-text\">useState</code>) of the image as it is loading. This will allow users of our <code class=\"language-text\">useImage</code> hook to know whether or not the image has loaded. We will add states for loading, loaded, and failed. Additionally we are going to need to know when the component is updated, so we will need to <code class=\"language-text\">useEffect</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> useState<span class=\"token punctuation\">,</span> useEffect <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span>\n<span class=\"token keyword\">import</span> loadImage <span class=\"token keyword\">from</span> <span class=\"token string\">'./loadImage.js'</span>\n\n<span class=\"token keyword\">const</span> Status <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token constant\">LOADING</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'loading'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token constant\">LOADED</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'loaded'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token constant\">FAILED</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'failed'</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">function</span> <span class=\"token function\">useImage</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">src</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>status<span class=\"token punctuation\">,</span> setStatus<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span>initialState<span class=\"token punctuation\">)</span>\n\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>src <span class=\"token operator\">||</span> status <span class=\"token operator\">===</span> Status<span class=\"token punctuation\">.</span><span class=\"token constant\">LOADED</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span>\n\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> image <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">loadImage</span><span class=\"token punctuation\">(</span>src<span class=\"token punctuation\">)</span>\n      <span class=\"token function\">setStatus</span><span class=\"token punctuation\">(</span>Status<span class=\"token punctuation\">.</span><span class=\"token constant\">LOADED</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">setStatus</span><span class=\"token punctuation\">(</span>Status<span class=\"token punctuation\">.</span><span class=\"token constant\">FAILED</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>src<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>status<span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This is starting to look like an actual hook. We could do better though. Let’s add a cache to reuse image objects. This will make future attempts to load a particular cached <code class=\"language-text\">src</code> avoid loading entirely. </p>\n<p>Additionally we should make sure we call <code class=\"language-text\">useRef</code> to keep track of whether or not we are mounted. This is necessary so we do not try to load images when the component is no longer mounted.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> useState<span class=\"token punctuation\">,</span> useEffect<span class=\"token punctuation\">,</span> useRef <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span>\n\n<span class=\"token keyword\">import</span> loadImage <span class=\"token keyword\">from</span> <span class=\"token string\">'./loadImage.js'</span>\n\n<span class=\"token keyword\">const</span> cache <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> Status <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token constant\">LOADING</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'loading'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token constant\">LOADED</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'loaded'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token constant\">FAILED</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'failed'</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">function</span> <span class=\"token function\">useImage</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">src</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> cachedImg <span class=\"token operator\">=</span> cache<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>src<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> initialState <span class=\"token operator\">=</span> cachedImg <span class=\"token operator\">?</span> Status<span class=\"token punctuation\">.</span><span class=\"token constant\">LOADED</span> <span class=\"token punctuation\">:</span> Status<span class=\"token punctuation\">.</span><span class=\"token constant\">LOADING</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>status<span class=\"token punctuation\">,</span> setStatus<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span>initialState<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> mounted <span class=\"token operator\">=</span> <span class=\"token function\">useRef</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span>\n    <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>src <span class=\"token operator\">||</span> status <span class=\"token operator\">===</span> Status<span class=\"token punctuation\">.</span><span class=\"token constant\">LOADED</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span>\n      mounted<span class=\"token punctuation\">.</span>current <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n\n      <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> image <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">loadImage</span><span class=\"token punctuation\">(</span>src<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>mounted<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span>\n\n        cache<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>src<span class=\"token punctuation\">,</span> image<span class=\"token punctuation\">)</span>\n        <span class=\"token function\">setStatus</span><span class=\"token punctuation\">(</span>Status<span class=\"token punctuation\">.</span><span class=\"token constant\">LOADED</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>mounted<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span>\n\n        cache<span class=\"token punctuation\">.</span><span class=\"token function\">delete</span><span class=\"token punctuation\">(</span>src<span class=\"token punctuation\">)</span>\n        <span class=\"token function\">setStatus</span><span class=\"token punctuation\">(</span>Status<span class=\"token punctuation\">.</span><span class=\"token constant\">FAILED</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        mounted<span class=\"token punctuation\">.</span>current <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span>src<span class=\"token punctuation\">,</span> status<span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>status<span class=\"token punctuation\">,</span> cachedImg<span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Notice I used a <code class=\"language-text\">Map</code> here for the cache. If you are using older browsers and are not transpiling your code using something like <code class=\"language-text\">babel</code> I recommend using a simple object instead.</p>\n<p>Let’s see how we might use <code class=\"language-text\">useImage</code> in the wild.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> React <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span>\n<span class=\"token keyword\">import</span> useImage<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> Status <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./useImage.js'</span>\n\n<span class=\"token keyword\">import</span> fallback <span class=\"token keyword\">from</span> <span class=\"token string\">'./fallback.png'</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">function</span> <span class=\"token function\">Image</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> src <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>status<span class=\"token punctuation\">,</span> image<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useImage</span><span class=\"token punctuation\">(</span>src<span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">===</span> Status<span class=\"token punctuation\">.</span><span class=\"token constant\">LOADING</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token operator\">&lt;</span>div className<span class=\"token operator\">=</span><span class=\"token string\">\"spinner\"</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n  <span class=\"token punctuation\">}</span>\n  \n  <span class=\"token keyword\">let</span> source\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">===</span> Status<span class=\"token punctuation\">.</span><span class=\"token constant\">FAILED</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    source <span class=\"token operator\">=</span> fallback\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    source <span class=\"token operator\">=</span> src\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token operator\">&lt;</span>img src<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>source<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Great! This is a super flexible API to work with, and can easily be extended to do numerous things. Such as LQIP, lazy loading, or anything we may need. If you wanted you could add <code class=\"language-text\">onLoad</code> and <code class=\"language-text\">onError</code> callbacks to this hook, but ideally you can do everything you want in render now that you have the <code class=\"language-text\">status</code>.</p>\n<p>As an exercise try adding <code class=\"language-text\">IntersectionObserver</code> to this hook. Make it only download a given image until the image is actually on screen. Go a step further and display a placeholder until the image is on screen. You will end up with a really convenient way to handle lazy loading, and prevent your browser from downloading images unnecessarily. This can save a lot of bandwidth for your users, as well as make your page load much faster!</p>\n<p>If you made a powerful image loader, found this instructional interesting, or just want to ask me something, feel free to bring it up in the comments below.</p>\n<p>Thanks for reading</p>","fields":{"slug":"/posts/react-image-hook/","tagSlugs":["/tag/javascript/","/tag/react/"]},"frontmatter":{"date":"2019-07-11T05:57:00.000Z","description":"Writing an effective image loader using react hooks","tags":["Javascript","React"],"title":"React Image Hook"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/posts/react-image-hook/"}}}